<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Improved Video Call App</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f4f4f4;
      font-family: sans-serif;
    }

    .container {
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 100%;
      max-width: 500px;
    }

    video {
      width: 100%;
      max-width: 400px;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    button {
      background-color: #007bff;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background-color: #0069d9;
    }

    #userList {
      list-style: none;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    #userList li {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    #userList li:hover {
      background-color: #f9f9f9;
    }

    #statusMessage {
      margin-top: 20px;
      font-size: 14px;
      color: #555;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="container">
  <div id="userIdDisplay"></div>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
  <ul id="userList"></ul>
  <input type="text" id="remoteUserId" placeholder="Enter remote user ID"> 
  <button id="callButton">Call</button>
  <button id="hangupButton" disabled>Hang Up</button>
  <div id="statusMessage"></div>
  <div class="spinner hidden" id="loadingIndicator"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
<script>
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const callButton = document.getElementById('callButton');
  const hangupButton = document.getElementById('hangupButton');
  const userIdDisplay = document.getElementById('userIdDisplay');
  const statusMessage = document.getElementById('statusMessage');
  const loadingIndicator = document.getElementById('loadingIndicator');

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB6C4lldmXfzJh-76hJS4NYnV6FAa9I5hE",
    authDomain: "lonyichat-2d82b.firebaseapp.com",
    databaseURL: "https://lonyichat-2d82b-default-rtdb.firebaseio.com",
    projectId: "lonyichat-2d82b",
    storageBucket: "lonyichat-2d82b.firebasestorage.app",
    messagingSenderId: "925529919968",
    appId: "1:925529919968:web:48673ceb273d4bc15d9b85",
    measurementId: "G-J3Y65DK02S"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();
  const callRef = database.ref('calls');
  const usersRef = database.ref('users');

  let peerConnection;
  let localStream;
  let callInProgress = false;

  const iceServers = [
    {
      urls: "stun:stun.l.google.com:19302", // Use a free STUN server
    },
    {
      urls: "turn:your.turn.server", // Replace with your TURN server (optional)
      username: "user",
      credential: "password"
    }
  ];

  // Function to get user media (camera and microphone)
  async function getMedia() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({
        video: { width: 640, height: 360 }, // Optimize for lower bandwidth
        audio: true
      });
      localVideo.srcObject = localStream;
    } catch (error) {
      showStatusMessage('Error accessing media devices. Check permissions.', true);
      console.error('Error accessing media devices:', error);
    }
  }

  // Show or hide the spinner (loading indicator)
  function toggleLoading(show) {
    if (show) {
      loadingIndicator.classList.remove('hidden');
    } else {
      loadingIndicator.classList.add('hidden');
    }
  }

  // Function to display status messages
  function showStatusMessage(message, isError = false) {
    statusMessage.textContent = message;
    statusMessage.style.color = isError ? 'red' : 'green';
  }

  // Function to create the peer connection and handle ICE candidates
  async function createPeerConnection(remoteUserId) {
    peerConnection = new RTCPeerConnection({ iceServers });

    localStream.getTracks().forEach(track => {
      peerConnection.addTrack(track, localStream);
    });

    peerConnection.ontrack = event => {
      remoteVideo.srcObject = event.streams[0];
    };

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        callRef.child(auth.currentUser.uid).child('callerCandidates').push(event.candidate.toJSON());
      }
    };

    callRef.child(remoteUserId).child('calleeCandidates').on('child_added', snapshot => {
      const candidate = new RTCIceCandidate(snapshot.val());
      peerConnection.addIceCandidate(candidate);
    });
  }

  async function makeCall(remoteUserId) {
    if (callInProgress) return;
    showStatusMessage('Starting call...');
    toggleLoading(true);
    await getMedia();
    await createPeerConnection(remoteUserId);

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    callRef.child(auth.currentUser.uid).set({ offer: offer.toJSON() });

    callRef.child(auth.currentUser.uid).on('value', snapshot => {
      const data = snapshot.val();
      if (data?.answer) {
        const answer = new RTCSessionDescription(data.answer);
        peerConnection.setRemoteDescription(answer);
        showStatusMessage('Call connected!');
        toggleLoading(false);
      }
    });

    callInProgress = true;
    callButton.disabled = true;
    hangupButton.disabled = false;
  }

  function hangUpCall() {
    if (!callInProgress) return;
    showStatusMessage('Call ended.');
    if (peerConnection) peerConnection.close();
    localStream?.getTracks().forEach(track => track.stop());
    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
    toggleLoading(false);
    callInProgress = false;
    callButton.disabled = false;
    hangupButton.disabled = true;
  }

  hangupButton.addEventListener('click', hangUpCall);
  callButton.addEventListener('click', () => {
    const remoteUserId = document.getElementById('remoteUserId').value;
    if (remoteUserId) {
      makeCall(remoteUserId);
    } else {
      showStatusMessage('Please enter a valid remote user ID.', true);
    }
  });

  auth.onAuthStateChanged(user => {
    if (user) {
      userIdDisplay.textContent = `Your User ID: ${user.uid}`;
      usersRef.child(user.uid).set(true);
      usersRef.child(user.uid).onDisconnect().remove();
    }
  });

  getMedia();
</script>

</body>
</html>
